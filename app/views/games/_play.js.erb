var skyjo = (function() {

  var elm;
  var polling = true;
  var data = {
    player_id: <%= @player.id %>,
    last_message_id: 0
  };

  function poll() {
    $.ajax('/updates.json', {

      data: data,

      dataType: 'json',

      success: function(json, status, xhr) {
        $.each(json.updates, function(i, update) {
          elm.ports.updates.send(update);
        });
        data.last_message_id = json.last_message_id;
        $('#responses').append('<pre>' + prettyPrintJson.toHtml(json) + '</pre>');
      },

      error: function(xhr) {
        console.log("ajax error: " + xhr.status);
      },

      complete: function(xhr) {
        if (polling) setTimeout(poll, 10000);
      }

    });
  }

  function set_elm(app) {
    elm = app;
  }

  return {
    poll: poll,
    set_elm: set_elm
  };

})();

$(function() {
  var app = Elm.Main.init({
    node: $('#elm-main').get(0),
    flags: {
      player: <%= @player.id %>
    }
  });
  skyjo.set_elm(app);
  skyjo.poll();
});
