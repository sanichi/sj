var skyjo = (function() {

  var elm;
  var pulling = true;
  var data = {
    player_id: <%= @player.id %>,
    last_message_id: 0
  };

  function pull() {
    $.ajax('/pull.json', {
      data: data,
      dataType: 'json',
      success: function(json, status, xhr) {
        if (json.abort) abort();
        $.each(json.updates, function(i, update) {
          if (update.mid > data.last_message_id) data.last_message_id = update.mid;
          elm.ports.pullUpdate.send(update);
        });
        if (!empty(json)) $('#responses').append('<pre>' + prettyPrintJson.toHtml(json) + '</pre>');
      },
      error: function(xhr) {
        console.log("ajax pull error: " + xhr.status);
      },
      complete: function(xhr) {
        if (pulling) setTimeout(pull, 2500);
      }
    });
  }

  function push(updates) {
    // updates.game_id = <%= @game.id %>; - XXX idea for refactor
    $.ajax('/push.json', {
      data: updates,
      dataType: 'json',
      error: function(xhr) {
        console.log("ajax push error: " + xhr.status);
      }
    });
  }

  function abort() {
    window.location.href = '<%= waiting_games_path %>';
  }

  function empty(obj) {
    return $.type(obj.updates) == 'array' && obj.updates.length == 0
  }

  function set_elm(app) {
    elm = app;
  }

  return {
    pull: pull,
    push: push,
    set_elm: set_elm
  };

})();

$(function() {
  var app = Elm.Main.init({
    node: $('#elm-main').get(0),
    flags: {
      player_id: <%= @player.id %>,
      players: [ <%= game_js_player_list(@game, @player.id) %> ]
    }
  });
  app.ports.pushUpdates.subscribe(function(updates) {
    skyjo.push(updates);
  });
  skyjo.set_elm(app);
  skyjo.pull();
});
